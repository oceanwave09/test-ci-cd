.linting:
  variables:
    PROJECT_ROOT: ""
  before_script:
    - pip install flake8
  script:
    - flake8 --exit-zero ${PROJECT_ROOT}

.test:
  variables:
    PROJECT_ROOT: ""
  stage: test
  before_script:
    - pip install pytest
    - cd ${PROJECT_ROOT}/
    - pip install -e .
  script:
    - pytest tests

.release:
  variables:
    PROJECT_ROOT: ""
    GITLAB_CI: 'true'
    GH_TOKEN: ${CI_JOB_TOKEN}
  before_script:
    - pip install poetry python-semantic-release==7.34.3
    - cd ${PROJECT_ROOT}/
    - poetry install --without test
    - echo "Setting up gitlab ci token"
    - echo -e "machine gitlab.com\nlogin gitlab-ci-token\npassword ${CI_JOB_TOKEN}" > ~/.netrc
    - git config --global user.email "project_${project_id}_bot@healthec.com"
    - git config --global user.name "project_${project_id}_bot"
    # - git remote set-url origin https://gitlab-ci-token:${GL_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
    - git checkout $CI_COMMIT_BRANCH
    # - semantic-release --version
    - git fetch --tags
    - git tag
  script:
    # - poetry run semantic-release -vvv version
    # - poetry run semantic-release -vvv publish
    - poetry run semantic-release -v DEBUG print-version
    - poetry run semantic-release -v DEBUG publish

  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_TAG == null'
      changes:
        paths:
          - ${PROJECT_ROOT}/**/*
